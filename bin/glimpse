#!/usr/bin/env python

from datetime import datetime
import h5py
import numpy as np
from socket import gethostname

from euxfel_karabo_bridge import Client


def gen_filename(endpoint):
    now = datetime.now().strftime('%Y%m%d_%H%M%S')
    _, host, port = endpoint.replace('/', '').split(':')
    if host == 'localhost':
        host = gethostname()
    return '{}_{}_{}.h5'.format(host, port, now)


def dict_to_hdf5(dic, endpoint):
    filename = gen_filename(endpoint)
    with h5py.File(filename, 'w') as handler:
        walk_dict_to_hdf5(dic, handler)


def walk_dict_to_hdf5(dic, h5):
    for key, value in dic.items():
        if isinstance(value, dict):
            group = h5.create_group(key)
            walk_dict_to_hdf5(value, group)
        elif isinstance(value, (np.ndarray)):
            h5.create_dataset(key, data=value, dtype=value.dtype)
        else:
            print('not supported', type(value))


if __name__ == '__main__':
    # TODO: cli options
    endpoint = 'tcp://localhost:12323'

    client = Client(endpoint)
    data = client.next()

    dict_to_hdf5(data, endpoint)